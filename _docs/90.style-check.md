# 代码风格与规范检查

本文档记录了 `post-sync` 项目的代码风格、模块规范及最佳实践，所有开发工作都应严格遵循以下约定。

## 1. 模块系统 (Module System)

* **ES Modules**: 项目全面采用 ECMAScript Modules (ESM) 规范。
    * `package.json` 中必须包含 `"type": "module"`。
    * `tsconfig.json` 中 `module` 和 `moduleResolution` 应设置为 `NodeNext`。
    * **文件扩展名**: 相对导入路径（local imports）**必须**包含 `.js` 扩展名。
        * ✅ `import { config } from './config.js';`
        * ❌ `import { config } from './config';`
    * **Shebang**: 在 ESM 项目中，避免在 TypeScript 源文件中使用 `#!/usr/bin/env ts-node` Shebang，应通过 `package.json` 的
      `bin` 字段或启动脚本处理。

## 2. 导出与导入 (Exports & Imports)

* **命名导出 (Named Exports)**: 优先使用命名导出，**严禁**非必要的 `export default`。
    * 这有助于提高代码的可读性、可维护性以及重构时的安全性。
    * ✅ `export const logger = { ... };`
    * ❌ `export default logger;`
* **命名导入 (Named Imports)**: 对应地，使用命名导入来引入模块。
    * ✅ `import { logger } from './logger.js';`
    * ❌ `import logger from './logger.js';`

## 3. 测试规范 (Testing)

* **框架**: 使用 `jest` 配合 `ts-jest` 进行测试。
* **配置**:
    * 使用 `ts-jest/presets/default-esm` 预设以支持 ESM。
    * 配置 `moduleNameMapper` 以处理 `.js` 扩展名映射。
    * 配置 `transformIgnorePatterns` 以正确处理 node_modules 中的 ESM 依赖（如 `marked`）。
* **Mocking**:
    * 对于外部依赖（如 `axios`, `sharp`），使用 `jest.mock()` 进行模拟。
    * 避免在测试文件中包含可能会破坏 Jest 环境的全局 Mock（如直接 Mock `fs/promises` 可能会导致 `graceful-fs` 错误），应优先使用
      `jest.spyOn` 或局部 Mock。

## 4. 类型安全 (TypeScript)

* **严格模式**: `tsconfig.json` 中启用 `"strict": true`。
* **显式类型**: 尽可能显式定义变量和函数返回值的类型，避免隐式 `any`。

## 5. 代码组织

* **服务层**: 业务逻辑应封装在 `src/services/` 目录下的服务类中。
* **工具类**: 通用工具函数应放在 `src/utils/` 目录下。
* **配置管理**: 统一通过 `src/config.ts` 管理环境变量和应用配置。
* **错误处理**: 使用 `src/errors.ts` 中定义的自定义错误类（如 `AppError`, `ApiError`）进行统一的错误抛出和捕获。
