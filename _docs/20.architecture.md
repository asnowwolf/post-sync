# 架构设计：社交媒体自动发文工具

## 1. 设计原则

- **CLI 优先**: 构建一个简单易用的命令行工具作为主要交互界面。
- **配置灵活**: 敏感信息（如 API密钥）和运行时配置应易于管理，与代码分离。
- **状态持久化**: 在本地记录发布状态，以支持增量更新并避免重复操作。
- **代码清晰**: 遵循 Vibe Coding 规范，确保代码的可读性和可维护性。

## 2. 技术栈

- **开发语言**: TypeScript / Node.js
- **包管理**: npm
- **核心依赖**:
    - **CLI框架**: `commander` - 用于快速构建功能丰富的命令行接口。
    - **HTTP客户端**: `axios` - 用于调用微信 API。
    - **数据库**: `better-sqlite3` - 用于在本地 SQLite 数据库中进行状态管理。
    - **Markdown解析**: `marked` - 用于将 Markdown 转换为 HTML。
    - **代码高亮**: `highlight.js` - 用于在 HTML 中实现代码语法高亮。
    - **图片处理**: `sharp` - 高性能图片处理库，用于调整尺寸和裁剪。
    - **API请求构建**: `form-data` - 用于构建 `multipart/form-data` 请求。
    - **文件哈希**: `crypto` (Node.js 内置) - 用于计算文件 MD5。

## 3. 核心工作流

### A. `create` 命令工作流 (创建草稿)

1. **初始化**: 解析 `create` 命令和参数。
2. **数据库连接**: 连接到 `.ps/db.sqlite` 数据库，如果不存在则初始化 Schema。
3. **识别文件列表**: 根据输入路径（文件或目录）生成待处理文件列表。
4. **遍历处理**: 对每个文件，通过查询数据库检查其 `source_hash`。如果文件未改变，则跳过。
5. **内容转换**: 对新文件或已修改的文件，执行内容转换流程（图片处理等），临时文件存放在 `.ps` 目录下。
6. **创建草稿**: 调用 API 创建草稿，获取 `media_id`。
7. **更新数据库**: 将文章信息、哈希值和 `media_id` `INSERT` 或 `UPDATE` 到数据库中。
8. **输出报告**: 在控制台报告处理结果。

### B. `publish` 命令工作流 (发布文章)

1. **初始化**: 解析 `publish` 命令和参数。
2. **数据库连接**: 连接到 `.ps/db.sqlite` 数据库。
3. **识别待发布草稿**: 根据输入路径，查询数据库获取对应的 `media_id`。
4. **遍历发布**: 对每个 `media_id`，调用 `freepublish/submit` 接口提交发布。
5. **更新数据库**: 将返回的 `publish_id` 和状态更新到数据库。
6. **输出报告**: 在控制台报告已提交的任务。

### C. `clean` 命令工作流

1. **定位 `.ps` 目录**: 在当前工作目录下找到 `.ps` 目录。
2. **遍历清理**: 遍历 `.ps` 目录，删除除 `db.sqlite` 之外的所有文件和子目录。
3. **输出报告**: 报告清理完成。

## 4. 状态管理 (`.ps` 目录)

`.ps` 目录用于两种目的：

1. **临时文件存储**: 存放图片处理等操作生成的中间文件。
2. **状态数据库**: 存放 `db.sqlite` 文件。

### 数据库 Schema (`db.sqlite`)

1. **`articles` Table**: 存储源文件的基本信息。
    - `id` (INTEGER, PRIMARY KEY)
        - `source_path` (TEXT, UNIQUE): 源 Markdown 文件的路径（相对于 `.ps` 目录的父目录）。
    - `source_hash` (TEXT): 最新一次处理时文件的 MD5 哈希值。
    - `created_at` (TEXT)
    - `updated_at` (TEXT)

2. **`drafts` Table**: 存储草稿信息。
    - `id` (INTEGER, PRIMARY KEY)
    - `article_id` (INTEGER, FOREIGN KEY to `articles.id`): 关联的文章。
    - `media_id` (TEXT, NOT NULL): 微信返回的草稿 ID。
    - `created_at` (TEXT): 草稿在微信后台的创建时间。

3. **`publications` Table**: 存储正式发布的信息。
    - `id` (INTEGER, PRIMARY KEY)
    - `draft_id` (INTEGER, FOREIGN KEY to `drafts.id`): 关联的草稿。
    - `publish_id` (TEXT): 微信返回的发布任务 ID。
    - `status` (TEXT): 'pending', 'success', 'failed'。
    - `article_url` (TEXT): 最终发布的文章链接。
    - `submitted_at` (TEXT)
    - `finished_at` (TEXT)

## 5. 错误处理策略

- 所有数据库操作都应在事务中执行，确保数据一致性。
- API 请求失败时，应向用户清晰地展示错误信息。
- 文件读写失败时，应提供明确的路径和权限错误提示。
