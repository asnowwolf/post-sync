# 任务分解：社交媒体自动发文工具

本任务清单旨在指导 Gemini CLI 完成 `post-sync` 项目的开发。每个任务都包含一个子任务列表，用于跟踪进度。

---

## Epic 1: 项目基础架构

### **任务 1.1: 初始化项目**
> **作为** 一名开发者，
> **我想要** 一个标准的 TypeScript 项目结构，
> **以便** 我可以开始编写代码和管理依赖。

**子任务:**
- [ ] `npm init -y`
- [ ] 安装 `typescript`, `ts-node`, `@types/node` 作为开发依赖。
- [ ] 创建 `tsconfig.json` 配置文件。
- [ ] 在 `package.json` 中添加 `"bin": { "post-sync": "src/index.ts" }` 字段。
- [ ] 创建 `src` 目录，并在其中创建 `index.ts`。
- [ ] 在 `src/index.ts` 文件顶部添加 `#!/usr/bin/env ts-node`。
- [ ] 设置 `package.json` 中的 `scripts` (如 `"start": "ts-node src/index.ts"`)。
- [ ] 初始化 `.gitignore` 文件。

### **任务 1.2: 核心模块与配置**
> **作为** 一个应用，
> **我需要** 一个统一的配置管理和错误处理机制，
> **以便** 在整个应用中安全、一致地处理配置和异常。

**子任务:**
- [ ] 创建配置模块，用于从环境变量和命令行参数中读取 `appId`, `appSecret`, `proxy`。
- [ ] 定义自定义错误类，用于处理 API、文件等不同类型的错误。
- [ ] 创建一个简单的日志模块，用于在控制台输出不同级别的日志。

---

## Epic 2: CLI 命令接口

### **任务 2.1: 实现 CLI 骨架**
> **作为** 一名用户，
> **我想要** 一个包含 `create`, `publish`, `clean` 命令的 CLI 工具，
> **以便** 我可以调用不同的核心功能。

**子任务:**
- [ ] 安装 `commander`。
- [ ] 在 `src/index.ts` (或 `src/cli.ts`) 中设置 `commander` 的基本结构。
- [ ] 定义 `create <path>` 命令。
- [ ] 定义 `publish <path>` 命令。
- [ ] 定义 `clean` 命令。
- [ ] 定义通用的 `--appId`, `--appSecret`, `--proxy` 选项。

---

## Epic 3: 状态管理 (数据库)

### **任务 3.1: 设置数据库模块**
> **作为** 一个应用，
> **我需要** 一个 SQLite 数据库来存储状态，
> **以便** 我可以持久化文章的发布记录。

**子任务:**
- [ ] 安装 `better-sqlite3` 和 `@types/better-sqlite3`。
- [ ] 创建数据库服务模块 (`src/services/db.service.ts`)。
- [ ] 实现数据库连接函数，该函数在 `.ps/db.sqlite` 不存在时自动创建它。
- [ ] 实现一个初始化函数，用于在首次创建数据库时执行 `CREATE TABLE` 语句，建立 `articles`, `drafts`, `publications` 表。
- [ ] 所有数据库操作都应封装在服务方法中（如 `getArticleByPath`, `updateDraft` 等）。

---

## Epic 4: 核心功能: `create` 命令

### **任务 4.1: 文件处理与哈希计算**
> **作为** `create` 命令，
> **我需要** 识别和排序输入文件，并检查它们是否有变动，
> **以便** 决定是否需要重新处理。

**子任务:**
- [ ] 实现一个文件工具模块 (`src/utils/file.util.ts`)。
- [ ] 实现函数：根据输入路径是文件还是目录，返回一个有序的文件列表。
- [ ] 实现函数：计算文件的 MD5 哈希值。
- [ ] 在 `create` 命令逻辑中，对每个文件，查询数据库中的 `source_hash` 并进行比较。

### **任务 4.2: Markdown 内容转换**
> **作为** `create` 命令，
> **我需要** 将 Markdown 文本转换为适用于微信公众号的 HTML，
> **以便** 创建草稿。

**子任务:**
- [ ] 安装 `marked` 和 `highlight.js`。
- [ ] 创建一个 `MarkdownConverter` 服务。
- [ ] 配置 `marked` 以使用 `highlight.js` 进行代码高亮。

### **任务 4.3: 图片处理与上传**
> **作为** `create` 命令，
> **我需要** 处理 Markdown 中的图片，将其上传到微信并替换链接，
> **以便** 文章能在公众号中正确显示图片。

**子任务:**
- [ ] 安装 `sharp` 和 `form-data`。
- [ ] 创建一个微信 API 服务模块 (`src/services/wechat.service.ts`)。
- [ ] 实现 `getAccessToken` 方法。
- [ ] 实现 `uploadImage` 方法，调用微信的 `media/uploadimg` API。
- [ ] 在 `MarkdownConverter` 中，使用 `marked` 的 `walkTokens` 或自定义渲染器来拦截图片。
- [ ] 对每个图片，下载或读取本地文件，使用 `sharp` 处理（如有需要），然后调用 `uploadImage` 上传。
- [ ] 将 Markdown 中的原图片 URL 替换为微信返回的 URL。
- [ ] 临时图片文件应存放在 `.ps` 目录下。

### **任务 4.4: 创建草稿并更新状态**
> **作为** `create` 命令，
> **我需要** 将最终的 HTML 内容创建为草稿，并记录状态，
> **以便** 完成发布流程。

**子任务:**
- [ ] 在 `wechat.service.ts` 中实现 `createDraft` 方法，调用 `freepublish/add_draft` API。
- [ ] 在 `create` 命令的主逻辑中，调用 `createDraft`。
- [ ] 成功后，调用数据库服务，将 `source_path`, `source_hash`, 和 `media_id` 存入数据库。

---

## Epic 5: 核心功能: `publish` 命令

### **任务 5.1: 实现 `publish` 命令逻辑**
> **作为** 一名用户，
> **我想要** 通过 `publish` 命令发布已有的草稿，
> **以便** 我可以完成文章的最终发表。

**子任务:**
- [ ] 在 `publish` 命令逻辑中，根据输入路径查询数据库，获取 `media_id` 列表。
- [ ] 在 `wechat.service.ts` 中实现 `submitPublish` 方法，调用 `freepublish/submit` API。
- [ ] 遍历 `media_id` 列表，调用 `submitPublish`。
- [ ] 调用数据库服务，将返回的 `publish_id` 存入 `publications` 表。
- [ ] (可选) 实现 `freepublish/get` 接口的轮询，以获取最终的文章 URL 并更新数据库。

---

## Epic 6: 核心功能: `clean` 命令

### **任务 6.1: 实现 `clean` 命令逻辑**
> **作为** 一名用户，
> **我想要** 清理项目中的临时文件，
> **以便** 保持工作目录的整洁。

**子任务:**
- [ ] 在 `clean` 命令逻辑中，实现文件系统操作。
- [ ] 读取 `.ps` 目录下的所有内容。
- [ ] 遍历并删除所有条目，但跳过 `db.sqlite` 文件。
- [ ] 打印清理完成的报告。
