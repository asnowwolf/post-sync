# 需求：社交媒体自动发文工具

## 1. 项目背景与目标

为了提高内容分发效率，减少人工操作，本项目旨在开发一个能将本地 Markdown 文稿自动发布到微信公众号的工具。

**核心目标**: 构建一个从内容获取、格式转换到最终发布的完整自动化流程，以实现高效、精准的微信公众号内容发布。同时，本项目也将作为验证
Gemini CLI Vibe Coding 能力的实践案例。

## 2. 目标用户

- 内容创作者
- 运营人员
- 希望实现内容自动化发布的开发者

## 3. 核心功能需求 (MVP)

1. **读取输入源**:
    - **单文件模式**: 支持指定单个 Markdown 文件作为输入，并为其创建一个草稿。
    - **合集模式**: 当输入为目录时，将该目录下的所有 Markdown 文件合并为一个合集草稿。
        - **文件排序**: 根据文件名的数字前缀对文件进行升序排序 (例如, `0010-a.md` 会排在 `0020-b.md` 之前)。
        - **内容合并**: 将排序后的文件内容依次合并。
2. **Markdown 到公众号格式转换**:
    - 支持标准的 Markdown 语法 (标题, 列表, 粗体, 斜体, 引用, 代码块等)。
    - **图片处理**:
        - 将 Markdown中的本地图片或网络图片上传至微信公众号素材库，并替换文中的图片链接。
        - 支持对图片进行处理，如调整分辨率、或在保持比例的前提下裁剪以填满指定尺寸（例如，作为文章封面）。
    - **代码块高亮**: 支持常见编程语言的代码高亮显示。
3. **调用微信公众号接口**:
    - **获取 `access_token`**: 使用微信公众号的 `getStableAccessToken` API 来安全地管理和刷新 `access_token`。
    - **上传素材**: 将转换后的内容和图片上传为永久素材。
    - **创建草稿**: 将处理好的内容在公众号后台创建为草稿。
4. **发布状态跟踪**:
    - 在处理的目录（或文件的所在目录）下创建并维护一个 `.ps` 目录。
    - 在 `.ps` 目录中记录每次发布的信息，包括：
        - 本地文件路径。
        - 文件的 MD5 哈希值，用于检测内容变更。
        - 成功上传后返回的草稿 `media_id`。
        - （未来扩展）最终发布的文章 URL。
    - 在重新发布前，通过 MD5 哈希值检查文件是否有变动，避免重复上传未修改的内容。

5. **命令行接口 (CLI)**:
    - 提供清晰的命令行指令来触发发布流程。
    - 示例:
        - 单文件发布: `post-sync <path-to-markdown-file.md>`
        - 批量发布: `post-sync <path-to-directory>`
    - 第一个参数为待发布的 Markdown 文件或目录路径，支持以下命名参数：
        - `--appId <your_app_id>`: 微信公众号的 AppID。
        - `--appSecret <your_app_secret>`: 微信公众号的 AppSecret。
        - `--proxy <proxy_url>`: 可选，HTTP/HTTPS 代理设置，用于网络请求。如 http://proxy.your-domain.com:3128

## 4. 技术栈选型

- **开发语言**: TypeScript / Node.js
- **核心框架**: 无，使用原生 Node.js API
- **依赖库**:
    - `axios`: 用于调用微信 API。
    - `sharp`: 用于处理图片，如调整尺寸和裁剪。
    - `marked` 或类似库: 用于解析 Markdown。
    - `highlight.js` 或类似库: 用于代码高亮。
    - `form-data`: 用于构建上传请求。
- **包管理**: npm 或 yarn

## 5. 自动化工作流

1. 用户在本地准备好 Markdown 格式的文章，文件名可包含数字前缀用于排序。
2. 用户在项目根目录执行 CLI 命令，并指定要发布的 Markdown 文件或目录路径。
3. **判断输入类型**:
    - **如果输入是单个文件**:
        1. 读取该文件内容。
        2. 继续执行下面的第 4 步。
    - **如果输入是目录**:
        1. 读取目录下所有 Markdown 文件。
        2. 根据文件名数字前缀进行排序。
        3. 将所有文件内容合并为一个单独的内容体。
        4. 继续执行下面的第 4 步。
4. 对合并后的内容，工具进行解析，找出所有图片链接。
5. 工具遍历图片链接，将图片上传到微信公众号服务器，获取返回的微信图片 URL。
6. 工具将原文中的旧图片链接替换为新的微信图片 URL。
7. 工具将处理后的完整 HTML 内容上传到公众号，创建一个新的草稿。
8. 工具在控制台返回成功信息，并附上草稿的 `media_id` 或相关提示。
9. 工具将本次发布的相关信息（文件路径/目录路径, MD5, media_id）记录到 `.ps` 管理目录中。

## 6. 非功能性需求

- **配置管理**: `appId` 和 `appSecret` 等敏感信息不应硬编码在代码中，应通过环境变量或配置文件传入。
- **错误处理**: 对 API 请求失败、文件读取错误等情况有明确的错误提示。
- **日志记录**: 关键步骤（如 API 调用、文件处理）应有日志输出，方便调试。

## 7. 验收标准

1. 可以成功执行命令并指定一个 Markdown 文件。
2. 执行后，微信公众号后台草稿箱中出现一篇新文章。
3. 文章的标题、正文、列表、引用等格式与 Markdown 源文件一致。
4. 文章中的所有图片（本地/网络）都已正确显示。
5. 代码块实现了语法高亮。
